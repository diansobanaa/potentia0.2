// File: backend/tests/load.k6

import http from 'k6/http';
import ws from 'k6/ws';
import { check, sleep } from 'k6';
import { Rate } from 'k6/metrics';

// Custom metrics
const mutationRate = new Rate('successful_mutations');

// Test configuration
export let options = {
  stages: [
    { duration: '2m', target: 100 }, // Ramp up to 100 users
    { duration: '5m', target: 100 }, // Stay at 100 users
    { duration: '2m', target: 200 }, // Ramp up to 200 users
    { duration: '5m', target: 200 }, // Stay at 200 users
    { duration: '2m', target: 0 },   // Ramp down
  ],
  thresholds: {
    http_req_duration: ['p(95)<200'], // 95% of requests must be below 200ms
    http_req_failed: ['rate<0.1'],    // Error rate must be less than 10%
    successful_mutations: ['rate>0.95'], // 95% of mutations must succeed
    websocket_connection_errors: ['rate<0.05'], // WS error rate < 5%
  },
};

const BASE_URL = 'http://localhost:8000';
const WS_URL = 'ws://localhost:8000';

// Helper function to get auth token
function getAuthToken() {
  // This should be replaced with actual login logic
  // For now, using a placeholder token
  const loginPayload = JSON.stringify({
    email: 'test@example.com',
    password: 'password'
  });
  
  const loginResponse = http.post(`${BASE_URL}/api/v1/auth/login`, loginPayload, {
    headers: { 'Content-Type': 'application/json' },
  });
  
  check(loginResponse, {
    'login successful': (r) => r.status === 200,
  });
  
  return loginResponse.json('access_token');
}

export function setup() {
  // Get a single auth token for all VUs (or implement per-VU login)
  // __ENV.TOKEN = getAuthToken();
  console.log('Load test setup complete');
}

export default function () {
  const token = __ENV.TOKEN || 'your-jwt-token'; // Use environment variable or placeholder
  const canvasId = 'your-canvas-id'; // Use a real canvas ID
  
  // Test 1: WebSocket Connection and Mutation
  try {
    const res = ws.connect(`${WS_URL}/api/v1/ws/canvas/${canvasId}?token=${token}`, {}, function (socket) {
      socket.on('open', () => {
        console.log('WebSocket connected');
        
        // Send a mutation
        const mutationPayload = {
          type: 'mutation',
          payload: {
            client_op_id: `k6-${__VU}-${Date.now()}`,
            block_id: null,
            canvas_id: canvasId,
            action: 'create',
            update_data: {
              type: 'text',
              content: `Load test block from VU ${__VU}`,
              y_order: 'a0'
            }
          }
        };
        
        socket.send(JSON.stringify(mutationPayload));
      });
      
      socket.on('message', (message) => {
        const data = JSON.parse(message);
        if (data.type === 'mutation' && data.payload.status === 'success') {
          mutationRate.add(1);
        }
      });
      
      socket.on('error', (error) => {
        console.error('WebSocket error:', error);
      });
    });
    
    check(res, { 'WebSocket status is 101': (r) => r && r.status === 101 });
    
  } catch (e) {
    console.error('Could not connect to WebSocket:', e);
  }
  
  // Test 2: HTTP API Fallback
  const mutationPayload = {
    client_op_id: `k6-http-${__VU}-${Date.now()}`,
    canvas_id: canvasId,
    action: 'create',
    update_data: {
      type: 'text',
      content: `HTTP load test block from VU ${__VU}`,
      y_order: 'a1'
    }
  };
  
  const mutationResponse = http.post(
    `${BASE_URL}/api/v1/canvas/${canvasId}/mutate`,
    JSON.stringify(mutationPayload),
    {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
      },
    }
  );
  
  check(mutationResponse, {
    'mutation status is 200': (r) => r.status === 200,
    'mutation response time < 500ms': (r) => r.timings.duration < 500,
  });
  
  sleep(1);
}